<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 매핑에 사용될 BoardMapper 인터페이스를 namespace 속성에 지정 필수! -->
<mapper namespace="com.itwillbs.mvc_board.mapper.BoardMapper">
	<!-- 게시물 등록 작업 - INSERT -->
	<!-- 
	단, 글번호(board_num) 컬럼이 일반 정수 컬럼이며 자동 증가 컬럼이 아니므로 직접 글번호 생성 필요
	이 때, 기존 게시물 번호 중 가장 큰 번호를 조회 후 + 1 값을 새 글 번호, 참조글 번호로 사용
	=> INSERT, UPDATE 태그 등에서 SELECT 구문 조회 결과값을 활용해야할 경우
	   <selectKey> 태그를 <insert> 등의 태그 내에서 사용하여 작업 전 또는 후에 값 조회 가능
	   - keyProperty 속성 : 조회 결과값을 저장할 속성(VO 객체 변수명 지정 가능)
	                        => 조회 후 자동으로 해당 객체의 변수(또는 일반 변수)에 저장됨
	                        => BoardVO 객체를 전달받았으므로 board_num 변수 직접 지정 가능
	   - resultType 속성 : 조회 결과에 대한 데이터 타입
	   - order 속성 : 작업 수행 시점 지정(작업 전 조회 수행 시 BEFORE, 작업 후 조회 수행 시 AFTER)
	=> 주의! MAX() 함수 사용 시 대상이 존재하지 않을 경우 NULL 값이 리턴되므로 사용 시 오류 발생함
	   따라서, IFNULL 함수 추가(NULL 일 때 기본값 0 로 설정)
	=> 전달받은 BoardVO 객체의 멤버변수에 selectkey 조회 결과값을 저장할 경우
	   해당 객체를 공유하는 다른 클래스에서 조회된 값 사용 가능
	-->
	<insert id="insertBoard">
		<selectKey keyProperty="board_num" resultType="int" order="BEFORE"> <!-- 참조형타입 변수(객체)를 넘겼으므로 참조 주소가 넘어감 -->
		<!-- 셀렉트를 주 쿼리 실행전에 하고 조회 결과는 int고 board_num이라는 이름으로 넘겨라 -->
		<!-- delete에는 없고 insert, update에는 있음 -->
		<!-- 주된 쿼리 적기전에 셀렉트 구문이 필요할 경우 사용 -->
			SELECT IFNULL(MAX(board_num), 0) -- null이 아닌 경우 0으로 지정해야 INSERT 구문에서 +1 할 것이므로 첫 글이 1번이 된다 
			FROM board
		</selectKey>
		INSERT INTO board
		VALUES(
			#{board_num} + 1 -- 미리 조회된 게시물 번호 + 1 값 사용
			, #{board_name}
			, #{board_subject}
			, #{board_content}
			, #{board_file1}
			, #{board_file2}
			, #{board_file3}
			, #{board_file}
			, #{board_num} + 1 -- board_re_ref(board_num 값과 동일하게 지정)
			, 0
			, 0
			, 0
			, now()
			, #{writer_ip}
		)
	</insert>
	
	
	<!-- 글 목록 조회 - SELECT -->
	<select id="selectBoardList" resultType="board">
		SELECT *
		FROM board
		ORDER BY
			board_re_ref DESC
			, board_re_seq ASC
		LIMIT
			#{startRow}
			, #{listLimit}
	</select>
	
	<!-- 전체 글 목록 갯수 조회 - SELECT -->
	<select id="selectBoardListCount" resultType="int">
		SELECT COUNT(*)
		FROM board
	</select>
	
</mapper>